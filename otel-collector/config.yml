# ============================================================================
# OPENTELEMETRY COLLECTOR CONFIGURATION
# Archivo: ./otel-collector/config.yml
# Gateway centralizado para recibir y distribuir telemetría
# ============================================================================

# ============================================================================
# RECEIVERS - Cómo recibe telemetría
# ============================================================================
receivers:
  # OTLP Receiver - Protocolo nativo de OpenTelemetry (PRINCIPAL)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        # USA ESTE: http://<IP-SERVIDOR>:4317
        # Ejemplo: OTEL_EXPORTER_OTLP_ENDPOINT=http://tu-servidor:4317
      
      http:
        endpoint: 0.0.0.0:4318
        # USA ESTE: http://<IP-SERVIDOR>:4318
        # Rutas específicas:
        # - Traces: http://<IP-SERVIDOR>:4318/v1/traces
        # - Metrics: http://<IP-SERVIDOR>:4318/v1/metrics
        # - Logs: http://<IP-SERVIDOR>:4318/v1/logs
  
  # Prometheus Receiver (opcional) - Scrapea métricas en formato Prometheus
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector'
          scrape_interval: 10s
          static_configs:
            - targets: ['localhost:8888']  # Métricas del collector mismo

  # Jaeger Receiver (opcional) - Por compatibilidad con apps legacy
  # jaeger:
  #   protocols:
  #     grpc:
  #       endpoint: 0.0.0.0:14250
  #     thrift_http:
  #       endpoint: 0.0.0.0:14268

  # Zipkin Receiver (opcional)
  # zipkin:
  #   endpoint: 0.0.0.0:9411

# ============================================================================
# PROCESSORS - Transforma/procesa telemetría en tránsito
# ============================================================================
processors:
  # Batch - Agrupa señales antes de exportar (IMPORTANTE para eficiencia)
  batch:
    timeout: 10s
    send_batch_size: 1024
    send_batch_max_size: 2048
  
  # Memory Limiter - Previene que el collector use demasiada RAM
  memory_limiter:
    check_interval: 1s
    limit_mib: 200  # Límite para t3.small
    spike_limit_mib: 50
  
  # Resource Detection - Añade metadata del entorno
  resourcedetection:
    detectors: [env, system, docker]
    timeout: 5s
  
  # Attributes - Añade/modifica atributos
  attributes:
    actions:
      - key: environment
        value: "lab"
        action: insert
      - key: cluster
        value: "observability-lab"
        action: insert
  
  # Resource - Modifica resource attributes
  resource:
    attributes:
      - key: service.namespace
        value: "default"
        action: insert
  
  # Transform - Transformaciones avanzadas (opcional)
  # transform:
  #   metric_statements:
  #     - context: metric
  #       statements:
  #         - set(description, "Transformed metric") where name == "old.metric.name"

# ============================================================================
# EXPORTERS - A dónde envía la telemetría
# ============================================================================
exporters:
  # OTLP Exporter - Para Tempo (trazas)
  otlp/tempo:
    endpoint: tempo:4317
    tls:
      insecure: true
  
  # Prometheus Remote Write - Para métricas
  prometheusremotewrite:
    endpoint: http://prometheus:9090/api/v1/write
    tls:
      insecure: true
    # Configuración de retry
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
  
  # Loki Exporter - Para logs
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    tls:
      insecure: true
    
    # Mapeo de atributos a labels de Loki
    labels:
      resource:
        service.name: "service_name"
        service.namespace: "namespace"
      attributes:
        level: "level"
        container.name: "container"
  
  # Logging Exporter - Para debug (imprime en stdout del collector)
  logging:
    verbosity: normal
    sampling_initial: 5
    sampling_thereafter: 200
  
  # Prometheus Exporter - Expone métricas en formato Prometheus
  prometheus:
    endpoint: "0.0.0.0:8889"
    # Accesible en: http://<IP-SERVIDOR>:8889/metrics
    # Prometheus puede scrapear este endpoint

# ============================================================================
# EXTENSIONS - Funcionalidades adicionales
# ============================================================================
extensions:
  # Health Check - Para verificar si el collector está vivo
  health_check:
    endpoint: 0.0.0.0:13133
    # Check: curl http://<IP-SERVIDOR>:13133
  
  # PPprof - Para profiling (debug)
  pprof:
    endpoint: 0.0.0.0:1777
  
  # zPages - Páginas de debug interactivas
  zpages:
    endpoint: 0.0.0.0:55679

# ============================================================================
# SERVICE - Pipeline que conecta receivers → processors → exporters
# ============================================================================
service:
  extensions: [health_check, pprof, zpages]
  
  # Pipeline de TRAZAS
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch, resourcedetection, resource, attributes]
      exporters: [otlp/tempo, logging]
      # Flujo: App → OTLP Receiver → Processors → Tempo
    
    # Pipeline de MÉTRICAS
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, batch, resourcedetection, resource]
      exporters: [prometheusremotewrite, prometheus, logging]
      # Flujo: App → OTLP Receiver → Processors → Prometheus
    
    # Pipeline de LOGS
    logs:
      receivers: [otlp]
      processors: [memory_limiter, batch, resourcedetection, resource, attributes]
      exporters: [loki, logging]
      # Flujo: App → OTLP Receiver → Processors → Loki
  
  # Telemetría del collector mismo
  telemetry:
    logs:
      level: info
    metrics:
      address: 0.0.0.0:8888
      # Métricas internas: http://<IP-SERVIDOR>:8888/metrics

# ============================================================================
# EJEMPLOS DE USO DESDE TUS APLICACIONES
# ============================================================================
#
# 1. VARIABLES DE ENTORNO (método más simple):
#    export OTEL_EXPORTER_OTLP_ENDPOINT=http://<IP-SERVIDOR>:4317
#    export OTEL_SERVICE_NAME=mi-servicio
#    export OTEL_RESOURCE_ATTRIBUTES=environment=lab,version=1.0
#
# 2. PYTHON:
#    from opentelemetry import trace
#    from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
#    from opentelemetry.sdk.trace import TracerProvider
#    from opentelemetry.sdk.trace.export import BatchSpanProcessor
#    
#    provider = TracerProvider()
#    processor = BatchSpanProcessor(
#        OTLPSpanExporter(endpoint="http://tu-servidor:4317", insecure=True)
#    )
#    provider.add_span_processor(processor)
#    trace.set_tracer_provider(provider)
#
# 3. JAVA:
#    OtlpGrpcSpanExporter exporter = OtlpGrpcSpanExporter.builder()
#        .setEndpoint("http://tu-servidor:4317")
#        .build();
#
# 4. NODE.JS:
#    const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-grpc');
#    const exporter = new OTLPTraceExporter({
#      url: 'http://tu-servidor:4317',
#    });
#
# 5. GO:
#    import "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
#    
#    exporter, _ := otlptracegrpc.New(
#        context.Background(),
#        otlptracegrpc.WithEndpoint("tu-servidor:4317"),
#        otlptracegrpc.WithInsecure(),
#    )
#
# ============================================================================